---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { Journey } from "../../data/content";
import { journeys } from "../../data/content";
import { getImage } from "astro:assets";
import terraImage from "../../assets/images/1513986998.jpg";
import { processMarkdown } from "../../utils/markdown";

export async function getStaticPaths() {
  const trips = journeys.filter((journey) => journey.type === "Reis");
  return Promise.all(
    trips.map(async (trip) => {
      let imageUrl =
        typeof trip.heroImage === "string" ? trip.heroImage : trip.heroImage?.src;
      let heroImageData;
      if (trip.heroImage) {
        // If it's a local image path, process it
        if (typeof trip.heroImage === "string") {
          if (trip.heroImage.startsWith("/src/assets/images/")) {
            if (trip.slug === "sola-terra-frankrijk") {
              heroImageData = await getImage({
                src: terraImage,
                width: 1400,
                quality: 85,
              });
              imageUrl = heroImageData.src;
            }
          }
        } else {
          heroImageData = await getImage({
            src: trip.heroImage,
            width: 1400,
            quality: 85,
          });
          imageUrl = heroImageData.src;
        }
      }
      return {
        params: { slug: trip.slug },
        props: { trip: { ...trip, heroImage: imageUrl, heroImageData } },
      };
    }),
  );
}

const { trip } = Astro.props as { trip: Journey };

// Process markdown content and extract TOC
const markdownContent = trip.longread || "";
const { html: htmlContent, toc } = processMarkdown(markdownContent);
const metaDescriptionBase = `${trip.shortDescription} Locatie: ${trip.location}. Data: ${trip.dates}.`;
const metaDescription =
  metaDescriptionBase.length > 160
    ? `${metaDescriptionBase.slice(0, 157).trimEnd()}...`
    : metaDescriptionBase;
const tripTitle = `SOLA Travel | ${trip.name} | ${trip.location}`;
const heroImageAlt = `${trip.name} in ${trip.location}`;
---

<BaseLayout
  title={tripTitle}
  description={metaDescription}
  ogImage={trip.heroImage}
  ogImageAlt={heroImageAlt}
>
  <section class="relative bg-base-900 text-white">
    {trip.heroImage && (
      <img
        class="absolute inset-0 w-full h-full object-cover opacity-45"
        src={trip.heroImage}
        width={trip.heroImageData?.width ?? 1400}
        height={trip.heroImageData?.height ?? 933}
        alt={heroImageAlt}
        loading="eager"
        decoding="async"
        fetchpriority="high"
      />
    )}
    <div class="relative max-w-6xl mx-auto px-6 py-24 space-y-6">
      <p class="uppercase text-xs tracking-[0.25em] text-white/70">
        {trip.type}
      </p>
      <h1 class="text-4xl lg:text-5xl font-semibold">{trip.name}</h1>
      <div class="flex flex-wrap gap-3 text-sm">
        <span class="px-3 py-1 rounded-full bg-white/15 border border-white/30"
          >{trip.location}</span
        >
        <span class="px-3 py-1 rounded-full bg-white/15 border border-white/30"
          >{trip.dates}</span
        >
        <span class="px-3 py-1 rounded-full bg-white/15 border border-white/30"
          >{trip.price}</span
        >
      </div>
      <div class="flex flex-wrap gap-3">
        <a
          href="#content"
          class="inline-flex items-center px-5 py-3 rounded-full bg-base-25 text-base-900 font-semibold"
          >Lees meer</a
        >
        <a
          href="/contact"
          class="inline-flex items-center px-5 py-3 rounded-full border border-white/60 text-white font-semibold"
          >Plan een gesprek</a
        >
      </div>
    </div>
  </section>

  {
    htmlContent && (
      <section id="content" class="max-w-6xl mx-auto px-6 py-14">
        <div class="flex flex-col lg:flex-row gap-8">
          {/* Table of Contents */}
          {toc.length > 0 && (
            <aside class="lg:w-64 shrink-0">
              <div class="sticky top-6">
                <h2 class="text-lg font-semibold text-base-900 mb-4">
                  Inhoudsopgave
                </h2>
                <nav class="space-y-2">
                  {toc.map((item) => (
                    <a
                      href={`#${item.id}`}
                      class={`block text-sm text-base-600 hover:text-accent-600 transition-colors ${
                        item.level === 2
                          ? "font-medium"
                          : item.level === 3
                            ? "ml-4"
                            : item.level === 4
                              ? "ml-8"
                              : ""
                      }`}
                    >
                      {item.text}
                    </a>
                  ))}
                </nav>
              </div>
            </aside>
          )}

          {/* Main Content */}
          <div class="flex-1 min-w-0">
            <div
              class="prose prose-lg prose-base-900 max-w-none
              prose-headings:font-semibold prose-headings:text-base-900
              prose-h2:text-2xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:scroll-mt-6
              prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-4 prose-h3:scroll-mt-6
              prose-h4:text-lg prose-h4:mt-6 prose-h4:mb-3 prose-h4:scroll-mt-6
              prose-p:text-base-700 prose-p:leading-relaxed prose-p:mb-4
              prose-ul:text-base-700 prose-ul:my-4
              prose-li:my-2
              prose-strong:text-base-900 prose-strong:font-semibold
              prose-a:text-accent-600 prose-a:no-underline hover:prose-a:underline"
              set:html={htmlContent}
            />
          </div>
        </div>
      </section>
    )
  }
</BaseLayout>
