---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { Journey } from "../../data/content";
import { journeys } from "../../data/content";
import { getImage } from "astro:assets";
import exerciseImage from "../../assets/images/2596052607.jpg";
import bewustwordingImage from "../../assets/images/2631991747.jpg";
import { extractHeadings, processMarkdown } from "../../utils/markdown";
import carouselImageOne from "../../assets/images/2596052607.jpg";
import carouselImageTwo from "../../assets/images/2631991747.jpg";
import carouselImageThree from "../../assets/images/hero.jpg";
import carouselImageFour from "../../assets/images/landscape.jpg";
import carouselImageFive from "../../assets/images/famenne.jpg";
import carouselImageSix from "../../assets/images/haute-loire.jpg";
import carouselImageSeven from "../../assets/images/1513986998.jpg";

export async function getStaticPaths() {
  const weekends = journeys.filter((journey) => journey.type === "Weekend");
  return Promise.all(
    weekends.map(async (weekend) => {
      let imageUrl = weekend.heroImage;
      // If it's a local image path, process it
      if (weekend.heroImage?.startsWith("/src/assets/images/")) {
        if (weekend.slug === "exercise-is-medicine") {
          const optimized = await getImage({
            src: exerciseImage,
            width: 1400,
            quality: 85,
          });
          imageUrl = optimized.src;
        } else if (weekend.slug === "bewustwording-connectie") {
          const optimized = await getImage({
            src: bewustwordingImage,
            width: 1400,
            quality: 85,
          });
          imageUrl = optimized.src;
        }
      }
      return {
        params: { slug: weekend.slug },
        props: { weekend: { ...weekend, heroImage: imageUrl } },
      };
    }),
  );
}

const { weekend } = Astro.props as { weekend: Journey };

const markdownContent = weekend.longread || "";
const toc = extractHeadings(markdownContent);
const sectionHeadings = toc.filter((item) => item.level === 2);
const keyFacts = weekend.keyFacts ?? [];
const faqItems = weekend.faq ?? [];

const buildAccordionSections = (markdown: string) => {
  const lines = markdown.split("\n");
  const introLines: string[] = [];
  const sections: { title: string; content: string }[] = [];
  let currentTitle = "";
  let currentContent: string[] = [];

  lines.forEach((line) => {
    const match = line.match(/^##\s+(.+)$/);
    if (match) {
      if (currentTitle) {
        sections.push({
          title: currentTitle,
          content: currentContent.join("\n").trim(),
        });
      } else if (introLines.length > 0) {
        introLines.push("");
      }
      currentTitle = match[1].trim();
      currentContent = [];
      return;
    }
    if (currentTitle) {
      currentContent.push(line);
    } else {
      introLines.push(line);
    }
  });

  if (currentTitle) {
    sections.push({
      title: currentTitle,
      content: currentContent.join("\n").trim(),
    });
  }

  return { introMarkdown: introLines.join("\n").trim(), sections };
};

const { introMarkdown, sections } = buildAccordionSections(markdownContent);
const introHtml = introMarkdown ? processMarkdown(introMarkdown).html : "";
const accordionSections = sections.map((section, index) => {
  const id = sectionHeadings[index]?.id ?? `section-${index + 1}`;
  const { html } = processMarkdown(section.content);
  return { ...section, id, html };
});

type TocEntry = {
  id: string;
  text: string;
  level: number;
  parentId: string;
};

const bewuswordingTocItems: TocEntry[] | null =
  weekend.slug === "bewustwording-connectie"
    ? [
        { text: "Voor wie", id: "voor-wie", level: 2, parentId: "voor-wie" },
        {
          text: "Wat je leert / focus",
          id: "wat-je-leert-focus",
          level: 2,
          parentId: "wat-je-leert-focus",
        },
        {
          text: "Na dit weekend",
          id: "na-dit-weekend",
          level: 2,
          parentId: "na-dit-weekend",
        },
        {
          text: "Expertise & coördinatie",
          id: "expertise-coordinatie",
          level: 2,
          parentId: "expertise-coordinatie",
        },
        {
          text: "Programma",
          id: "programma",
          level: 2,
          parentId: "programma",
        },
        {
          text: "Dag 1 - vrijdag",
          id: "dag-1-vrijdag",
          level: 3,
          parentId: "programma",
        },
        {
          text: "Dag 2 - zaterdag",
          id: "dag-2-zaterdag",
          level: 3,
          parentId: "programma",
        },
        {
          text: "Dag 3 - zondag",
          id: "dag-3-zondag",
          level: 3,
          parentId: "programma",
        },
        { text: "Verblijf", id: "verblijf", level: 2, parentId: "verblijf" },
        {
          text: "Maaltijden",
          id: "maaltijden",
          level: 2,
          parentId: "maaltijden",
        },
        {
          text: "Praktisch",
          id: "praktisch",
          level: 2,
          parentId: "praktisch",
        },
        {
          text: "Vroegboekcadeau",
          id: "vroegboekcadeau",
          level: 2,
          parentId: "vroegboekcadeau",
        },
        {
          text: "Wat is inbegrepen?",
          id: "wat-is-inbegrepen",
          level: 2,
          parentId: "wat-is-inbegrepen",
        },
        {
          text: "Wat is niet inbegrepen?",
          id: "wat-is-niet-inbegrepen",
          level: 2,
          parentId: "wat-is-niet-inbegrepen",
        },
        {
          text: "Boek je plek",
          id: "boek-je-plek",
          level: 2,
          parentId: "boek-je-plek",
        },
        {
          text: "Twijfel je?",
          id: "twijfel-je",
          level: 2,
          parentId: "twijfel-je",
        },
        {
          text: "Na inschrijving",
          id: "na-inschrijving",
          level: 2,
          parentId: "na-inschrijving",
        },
        {
          text: "Goed om weten - FAQ",
          id: "goed-om-weten-faq",
          level: 2,
          parentId: "goed-om-weten-faq",
        },
      ]
    : null;

let currentSectionId = "";
const tocItems: TocEntry[] =
  bewuswordingTocItems ??
  toc.map((item) => {
    if (item.level === 2) {
      currentSectionId = item.id;
    }
    return {
      ...item,
      parentId: currentSectionId || item.id,
    };
  });

const carouselImages = await Promise.all(
  [
    carouselImageOne,
    carouselImageTwo,
    carouselImageThree,
    carouselImageFour,
    carouselImageFive,
    carouselImageSix,
    carouselImageSeven,
  ].map(async (image) =>
    getImage({
      src: image,
      width: 900,
      quality: 85,
    }),
  ),
);
---

<BaseLayout
  title={`SOLA | ${weekend.name}`}
  description={weekend.shortDescription}
>
  <section class="relative bg-base-900 text-white">
    <div
      class="absolute inset-0 opacity-60"
      style={{
        backgroundImage: `url(${weekend.heroImage})`,
        backgroundSize: "cover",
        backgroundPosition: "center",
      }}
    >
    </div>
    <div class="relative max-w-6xl mx-auto px-6 py-24 space-y-6">
      <p class="uppercase text-xs tracking-[0.25em] text-white/70">
        {weekend.type}
      </p>
      <h1 class="text-4xl lg:text-5xl font-semibold">{weekend.name}</h1>
      <p class="text-base text-white/85 max-w-2xl leading-relaxed">
        {weekend.shortDescription}
      </p>
      <div class="flex flex-wrap gap-3 text-sm">
        <span class="px-3 py-1 rounded-full bg-white/15 border border-white/30"
          >{weekend.location}</span
        >
        <span class="px-3 py-1 rounded-full bg-white/15 border border-white/30"
          >{weekend.dates}</span
        >
        <span class="px-3 py-1 rounded-full bg-white/15 border border-white/30"
          >{weekend.price}</span
        >
      </div>
      <div class="flex flex-wrap gap-3">
        <a
          href="#boek-je-plek"
          data-accordion-target="boek-je-plek"
          class="inline-flex items-center px-5 py-3 rounded-full bg-base-25 text-base-900 font-semibold"
          >Boek nu</a
        >
        <a
          href="#twijfel-je"
          data-accordion-target="twijfel-je"
          class="inline-flex items-center px-5 py-3 rounded-full border border-white/60 text-white font-semibold"
          >Vragen? Plan een gesprek</a
        >
      </div>
    </div>
  </section>

  <section class="max-w-6xl mx-auto px-6 pt-12">
    <div class="flex items-end justify-between gap-4 mb-6">
      <div>
        <p class="uppercase text-xs tracking-[0.25em] text-base-500">
          Sfeerbeelden
        </p>
        <h2 class="text-2xl font-semibold text-base-900">
          Een blik op de setting
        </h2>
      </div>
      <p class="text-sm text-base-500 hidden lg:block">
        Scroll horizontaal om meer beelden te zien.
      </p>
    </div>
    <div class="carousel-wrapper -mx-6 px-6">
      <div class="carousel-track flex gap-4 overflow-x-auto snap-x snap-mandatory pb-4">
        {carouselImages.map((image, index) => (
          <div
            class="snap-start shrink-0 basis-64 sm:basis-80 lg:basis-[calc((100%-2rem)/3)]"
          >
            <img
              src={image.src}
              alt={`SOLA weekend sfeerbeeld ${index + 1}`}
              loading="lazy"
              decoding="async"
              class="h-56 w-full object-cover"
            />
          </div>
        ))}
      </div>
    </div>
  </section>

  {accordionSections.length > 0 && (
    <section id="content" class="max-w-6xl mx-auto px-6 pb-24 pt-12 lg:py-16">
      <div class="flex flex-col lg:flex-row gap-8 lg:gap-10">
        {tocItems.length > 0 && (
          <aside class="lg:w-52 shrink-0 order-2 lg:order-1">
            <div class="sticky top-6">
              <div class="border border-base-200 rounded-2xl p-4 bg-white shadow-sm">
                <div class="sticky top-0 bg-white pb-3">
                  <h2 class="text-base font-semibold text-base-900">
                    Inhoudsopgave
                  </h2>
                </div>
                <nav class="space-y-2">
                  {tocItems.map((item) => (
                    <a
                      href={`#${item.id}`}
                      data-accordion-link="weekend"
                      data-accordion-target={item.parentId}
                      class={`block text-sm text-base-600 hover:text-accent-600 transition-colors ${
                        item.level === 2
                          ? "font-medium"
                          : item.level === 3
                            ? "ml-4"
                            : item.level === 4
                              ? "ml-8"
                              : ""
                      }`}
                    >
                      {item.text}
                    </a>
                  ))}
                </nav>
              </div>
            </div>
          </aside>
        )}

        <div class="flex-1 min-w-0 order-1 lg:order-2">
          {introHtml && (
            <div
              class="prose prose-lg prose-base-900 max-w-none mb-8
              prose-p:text-base-700 prose-p:leading-relaxed"
              set:html={introHtml}
            />
          )}
          <div class="space-y-2">
            {accordionSections.map((section, index) => (
              <div
                id={section.id}
                data-accordion-section
                class="border-t border-base-200 last:border-b scroll-mt-24"
              >
                <button
                  type="button"
                  class="w-full flex items-center justify-between gap-4 px-2 py-4 text-left text-base-900 font-semibold focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500/50 transition hover:text-base-800 hover:bg-base-900/3"
                  aria-expanded={index === 0 ? "true" : "false"}
                  aria-controls={`weekend-panel-${index}`}
                  id={`weekend-trigger-${index}`}
                  data-accordion-trigger="weekend"
                  data-accordion-id={section.id}
                >
                  <span>{section.title}</span>
                  <span
                    class="ml-auto text-base-500 transition-colors duration-300"
                    aria-hidden="true"
                  >
                    +
                  </span>
                </button>
                <div
                  id={`weekend-panel-${index}`}
                  class={`accordion-panel px-2 text-base-700 leading-relaxed ${
                    index === 0 ? "pb-4 open" : "pb-0"
                  }`}
                  role="region"
                  aria-labelledby={`weekend-trigger-${index}`}
                  data-accordion-panel="weekend"
                >
                  {section.title === "Goed om weten - FAQ" && faqItems.length > 0 ? (
                    <div class="space-y-2" data-accordion-group="faq">
                      {faqItems.map((item, faqIndex) => (
                        <div
                          class={`border-t border-base-200 ${
                            faqIndex === faqItems.length - 1 ? "border-b" : ""
                          }`}
                        >
                          <button
                            type="button"
                            class="w-full flex items-center justify-between gap-4 px-2 py-4 text-left text-base-900 font-semibold focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500/50 transition hover:text-base-800 hover:bg-base-900/3"
                            aria-expanded="false"
                            aria-controls={`faq-panel-${index}-${faqIndex}`}
                            id={`faq-trigger-${index}-${faqIndex}`}
                            data-accordion-trigger="faq"
                          >
                            <span>{item.question}</span>
                            <span
                              class="ml-auto text-base-500 transition-colors duration-300"
                              aria-hidden="true"
                            >
                              +
                            </span>
                          </button>
                          <div
                            id={`faq-panel-${index}-${faqIndex}`}
                            class="accordion-panel px-2 text-base-700 leading-relaxed pb-0"
                            role="region"
                            aria-labelledby={`faq-trigger-${index}-${faqIndex}`}
                            data-accordion-panel="faq"
                          >
                            <div
                              class="prose prose-base-900 max-w-none prose-p:text-base-700 prose-p:leading-relaxed prose-p:mb-4 prose-ul:text-base-700 prose-ul:my-4 prose-li:my-2"
                              set:html={processMarkdown(item.answer).html}
                            />
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div
                      class="prose prose-base-900 max-w-none
                      prose-headings:font-semibold prose-headings:text-base-900
                      prose-h3:text-lg prose-h3:mt-6 prose-h3:mb-3 prose-h3:scroll-mt-24
                      prose-p:text-base-700 prose-p:leading-relaxed prose-p:mb-4
                      prose-ul:text-base-700 prose-ul:my-4
                      prose-li:my-2
                      prose-strong:text-base-900 prose-strong:font-semibold
                      prose-a:text-accent-600 prose-a:no-underline hover:prose-a:underline"
                      set:html={section.html}
                    />
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        {keyFacts.length > 0 && (
          <aside class="hidden lg:block lg:w-72 shrink-0 order-3">
            <div class="sticky top-6 space-y-4">
              <div class="rounded-2xl border border-base-200 bg-white p-5 shadow-sm">
                <h2 class="text-sm font-semibold text-base-500 uppercase tracking-[0.2em]">
                  In het kort
                </h2>
                <div class="mt-4 space-y-4 text-sm text-base-700">
                  {keyFacts.map((fact) => (
                    <div class="space-y-1">
                      <p class="text-xs uppercase tracking-[0.18em] text-base-500">
                        {fact.label}
                      </p>
                      {fact.lines.map((line) => (
                        <p class="text-sm text-base-800 leading-relaxed">
                          {line}
                        </p>
                      ))}
                    </div>
                  ))}
                </div>
                <div class="mt-6 space-y-3">
                  <a
                    href="#boek-je-plek"
                    data-accordion-target="boek-je-plek"
                    class="inline-flex w-full items-center justify-center rounded-full bg-accent-600 px-4 py-3 text-sm font-semibold text-white hover:bg-accent-700 transition-colors"
                  >
                    Boek nu
                  </a>
                  <a
                    href="#twijfel-je"
                    data-accordion-target="twijfel-je"
                    class="inline-flex w-full items-center justify-center rounded-full border border-base-300 px-4 py-3 text-sm font-semibold text-base-700 hover:border-base-400 hover:text-base-900 transition-colors"
                  >
                    Vragen? Plan een gesprek
                  </a>
                </div>
              </div>
            </div>
          </aside>
        )}
      </div>
    </section>
  )}

  <div class="fixed inset-x-0 bottom-0 z-40 border-t border-base-200 bg-white/95 backdrop-blur lg:hidden">
    <div class="max-w-6xl mx-auto px-4 py-3 space-y-3">
      {keyFacts.length > 0 && (
        <div class="flex gap-4 overflow-x-auto text-[11px] text-base-600 pb-1">
          {keyFacts.map((fact) => (
            <div class="shrink-0 min-w-[180px]">
              <p class="uppercase tracking-[0.2em] text-[10px] text-base-400">
                {fact.label}
              </p>
              <p class="text-[11px] text-base-700 leading-snug">
                {fact.lines.join(" · ")}
              </p>
            </div>
          ))}
        </div>
      )}
      <div class="flex gap-3">
        <a
          href="#boek-je-plek"
          data-accordion-target="boek-je-plek"
          class="flex-1 inline-flex items-center justify-center rounded-full bg-accent-600 px-4 py-3 text-sm font-semibold text-white hover:bg-accent-700 transition-colors"
        >
          Boek nu
        </a>
        <a
          href="#twijfel-je"
          data-accordion-target="twijfel-je"
          class="flex-1 inline-flex items-center justify-center rounded-full border border-base-300 px-4 py-3 text-sm font-semibold text-base-700 hover:border-base-400 hover:text-base-900 transition-colors"
        >
          Vragen? Plan een gesprek
        </a>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const accordionButtons = document.querySelectorAll(
        '[data-accordion-trigger="weekend"]',
      );
      const faqButtons = document.querySelectorAll(
        '[data-accordion-trigger="faq"]',
      );
      const ctaLinks = document.querySelectorAll("[data-accordion-target]");

      const closePanel = (button) => {
        const panelId = button.getAttribute("aria-controls");
        const panel = document.getElementById(panelId);
        const icon = button.querySelector("span[aria-hidden='true']");
        if (!panel || !icon) return;
        button.setAttribute("aria-expanded", "false");
        panel.style.maxHeight = "0px";
        panel.classList.remove("open");
        panel.classList.remove("pb-4");
        panel.classList.add("pb-0");
        icon.textContent = "+";
      };

      const openPanel = (button) => {
        const panelId = button.getAttribute("aria-controls");
        const panel = document.getElementById(panelId);
        const icon = button.querySelector("span[aria-hidden='true']");
        if (!panel || !icon) return;
        button.setAttribute("aria-expanded", "true");
        panel.classList.add("open");
        panel.classList.remove("pb-0");
        panel.classList.add("pb-4");
        panel.style.maxHeight = `${panel.scrollHeight}px`;
        icon.textContent = "–";
      };

      const togglePanel = (button) => {
        const isExpanded = button.getAttribute("aria-expanded") === "true";
        accordionButtons.forEach((item) => closePanel(item));
        if (!isExpanded) {
          openPanel(button);
        }
      };

      const updateParentPanelHeight = (button) => {
        const parentPanel = button.closest('[data-accordion-panel="weekend"]');
        if (!parentPanel || !parentPanel.classList.contains("open")) return;
        window.requestAnimationFrame(() => {
          parentPanel.style.maxHeight = `${parentPanel.scrollHeight}px`;
        });
      };

      const setPanelAutoHeight = (panel) => {
        if (!panel || !panel.classList.contains("open")) return;
        panel.style.maxHeight = "none";
      };

      const openFromTarget = (targetId) => {
        if (!targetId) return;
        let button = document.querySelector(
          `[data-accordion-id="${targetId}"]`,
        );
        if (!button) {
          const anchor = document.getElementById(targetId);
          const container = anchor?.closest("[data-accordion-section]");
          button = container?.querySelector(
            '[data-accordion-trigger="weekend"]',
          );
        }
        if (button) {
          accordionButtons.forEach((item) => closePanel(item));
          openPanel(button);
        }
      };

      accordionButtons.forEach((button) => {
        button.addEventListener("click", () => togglePanel(button));
        button.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            togglePanel(button);
          }
        });
      });

      faqButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const isExpanded = button.getAttribute("aria-expanded") === "true";
          const group = button.closest('[data-accordion-group="faq"]');
          const panelId = button.getAttribute("aria-controls");
          const panel = panelId ? document.getElementById(panelId) : null;
          const closeSiblings = () => {
            const siblingButtons = group?.querySelectorAll(
              '[data-accordion-trigger="faq"]',
            );
            siblingButtons?.forEach((item) => {
              if (item !== button) {
                closePanel(item);
              }
            });
          };
          if (isExpanded) {
            closePanel(button);
            updateParentPanelHeight(button);
          } else {
            closeSiblings();
            openPanel(button);
            updateParentPanelHeight(button);
            window.setTimeout(() => {
              setPanelAutoHeight(panel);
              updateParentPanelHeight(button);
            }, 320);
          }
        });
        button.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            const isExpanded = button.getAttribute("aria-expanded") === "true";
            const group = button.closest('[data-accordion-group="faq"]');
            const panelId = button.getAttribute("aria-controls");
            const panel = panelId ? document.getElementById(panelId) : null;
            const closeSiblings = () => {
              const siblingButtons = group?.querySelectorAll(
                '[data-accordion-trigger="faq"]',
              );
              siblingButtons?.forEach((item) => {
                if (item !== button) {
                  closePanel(item);
                }
              });
            };
            if (isExpanded) {
              closePanel(button);
              updateParentPanelHeight(button);
            } else {
              closeSiblings();
              openPanel(button);
              updateParentPanelHeight(button);
              window.setTimeout(() => {
                setPanelAutoHeight(panel);
                updateParentPanelHeight(button);
              }, 320);
            }
          }
        });
      });

      ctaLinks.forEach((link) => {
        link.addEventListener("click", () => {
          const targetId = link.getAttribute("data-accordion-target");
          window.setTimeout(() => openFromTarget(targetId), 0);
        });
      });

      const openFromHash = () => {
        const hash = window.location.hash.replace("#", "");
        if (hash) {
          openFromTarget(hash);
        }
      };

      accordionButtons.forEach((button) => {
        if (button.getAttribute("aria-expanded") === "true") {
          openPanel(button);
        }
      });

      window.addEventListener("hashchange", openFromHash);
      openFromHash();
    });
  </script>

  <style>
    .accordion-panel {
      max-height: 0;
      overflow: hidden;
      transition:
        max-height 0.3s ease,
        opacity 0.3s ease,
        padding 0.3s ease;
      opacity: 0;
    }

    .accordion-panel.open {
      opacity: 1;
    }

    .carousel-track::-webkit-scrollbar {
      height: 6px;
    }

    .carousel-track::-webkit-scrollbar-thumb {
      background: rgba(15, 23, 42, 0.2);
      border-radius: 999px;
    }

    .carousel-track::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</BaseLayout>
