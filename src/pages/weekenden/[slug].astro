---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { Journey } from "../../data/content";
import { journeys } from "../../data/content";
import { getImage } from "astro:assets";
import exerciseImage from "../../assets/images/2596052607.jpg";
import bewustwordingImage from "../../assets/images/2631991747.jpg";
import { processMarkdown } from "../../utils/markdown";

export async function getStaticPaths() {
  const weekends = journeys.filter((journey) => journey.type === "Weekend");
  return Promise.all(
    weekends.map(async (weekend) => {
      let imageUrl = weekend.heroImage;
      // If it's a local image path, process it
      if (weekend.heroImage?.startsWith("/src/assets/images/")) {
        if (weekend.slug === "exercise-is-medicine") {
          const optimized = await getImage({
            src: exerciseImage,
            width: 1400,
            quality: 85,
          });
          imageUrl = optimized.src;
        } else if (weekend.slug === "bewustwording-connectie") {
          const optimized = await getImage({
            src: bewustwordingImage,
            width: 1400,
            quality: 85,
          });
          imageUrl = optimized.src;
        }
      }
      return {
        params: { slug: weekend.slug },
        props: { weekend: { ...weekend, heroImage: imageUrl } },
      };
    }),
  );
}

const { weekend } = Astro.props as { weekend: Journey };

// Process markdown content and extract TOC
const markdownContent = weekend.longread || "";
const { html: htmlContent, toc } = processMarkdown(markdownContent);
---

<BaseLayout
  title={`SOLA | ${weekend.name}`}
  description={weekend.shortDescription}
>
  <section class="relative bg-base-900 text-white">
    <div
      class="absolute inset-0 opacity-60"
      style={{
        backgroundImage: `url(${weekend.heroImage})`,
        backgroundSize: "cover",
        backgroundPosition: "center",
      }}
    >
    </div>
    <div class="relative max-w-6xl mx-auto px-6 py-24 space-y-6">
      <p class="uppercase text-xs tracking-[0.25em] text-white/70">
        {weekend.type}
      </p>
      <h1 class="text-4xl lg:text-5xl font-semibold">{weekend.name}</h1>
      <div class="flex flex-wrap gap-3 text-sm">
        <span class="px-3 py-1 rounded-full bg-white/15 border border-white/30"
          >{weekend.location}</span
        >
        <span class="px-3 py-1 rounded-full bg-white/15 border border-white/30"
          >{weekend.dates}</span
        >
        <span class="px-3 py-1 rounded-full bg-white/15 border border-white/30"
          >{weekend.price}</span
        >
      </div>
      <div class="flex flex-wrap gap-3">
        <a
          href="#content"
          class="inline-flex items-center px-5 py-3 rounded-full bg-base-25 text-base-900 font-semibold"
          >Lees meer</a
        >
        <a
          href="/contact"
          class="inline-flex items-center px-5 py-3 rounded-full border border-white/60 text-white font-semibold"
          >Plan een gesprek</a
        >
      </div>
    </div>
  </section>

  {
    htmlContent && (
      <section id="content" class="max-w-6xl mx-auto px-6 py-14">
        <div class="flex flex-col lg:flex-row gap-8">
          {/* Table of Contents */}
          {toc.length > 0 && (
            <aside class="lg:w-64 shrink-0">
              <div class="sticky top-6">
                <h2 class="text-lg font-semibold text-base-900 mb-4">
                  Inhoudsopgave
                </h2>
                <nav class="space-y-2">
                  {toc.map((item) => (
                    <a
                      href={`#${item.id}`}
                      class={`block text-sm text-base-600 hover:text-accent-600 transition-colors ${
                        item.level === 2
                          ? "font-medium"
                          : item.level === 3
                            ? "ml-4"
                            : item.level === 4
                              ? "ml-8"
                              : ""
                      }`}
                    >
                      {item.text}
                    </a>
                  ))}
                </nav>
              </div>
            </aside>
          )}

          {/* Main Content */}
          <div class="flex-1 min-w-0">
            <div
              class="prose prose-lg prose-base-900 max-w-none
              prose-headings:font-semibold prose-headings:text-base-900
              prose-h2:text-2xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:scroll-mt-6
              prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-4 prose-h3:scroll-mt-6
              prose-h4:text-lg prose-h4:mt-6 prose-h4:mb-3 prose-h4:scroll-mt-6
              prose-p:text-base-700 prose-p:leading-relaxed prose-p:mb-4
              prose-ul:text-base-700 prose-ul:my-4
              prose-li:my-2
              prose-strong:text-base-900 prose-strong:font-semibold
              prose-a:text-accent-600 prose-a:no-underline hover:prose-a:underline"
              set:html={htmlContent}
            />
          </div>
        </div>
      </section>
    )
  }
</BaseLayout>
