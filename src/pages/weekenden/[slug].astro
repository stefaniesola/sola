---
import BaseLayout from "../../layouts/BaseLayout.astro";
import type { Journey } from "../../data/content";
import { journeys } from "../../data/content";
import { getImage } from "astro:assets";
import exerciseImage from "../../assets/images/2596052607.jpg";
import bewustwordingImage from "../../assets/images/2631991747.jpg";
import { marked } from "marked";
import ConversionHero from "../../components/weekend/ConversionHero.astro";
import StickyBookingCard from "../../components/weekend/StickyBookingCard.astro";
import Accordion from "../../components/weekend/Accordion.astro";
import ScrollSpyTOC from "../../components/weekend/ScrollSpyTOC.astro";
import simonPortrait from "../../assets/images/simon-helleputte.webp";

export async function getStaticPaths() {
  const weekends = journeys.filter((journey) => journey.type === "Weekend");
  return Promise.all(
    weekends.map(async (weekend) => {
      let imageUrl = weekend.heroImage;
      // If it's a local image path, process it
      if (weekend.heroImage?.startsWith("/src/assets/images/")) {
        if (weekend.slug === "exercise-is-medicine") {
          const optimized = await getImage({
            src: exerciseImage,
            width: 1400,
            quality: 85,
          });
          imageUrl = optimized.src;
        } else if (weekend.slug === "bewustwording-connectie") {
          const optimized = await getImage({
            src: bewustwordingImage,
            width: 1400,
            quality: 85,
          });
          imageUrl = optimized.src;
        }
      }
      return {
        params: { slug: weekend.slug },
        props: { weekend: { ...weekend, heroImage: imageUrl } },
      };
    }),
  );
}

const { weekend } = Astro.props as { weekend: Journey };
const markdownContent = weekend.longread || "";

const escapeRegExp = (value: string) =>
  value.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

const parseTopSections = (markdown: string) => {
  const sections: { heading: string; content: string }[] = [];
  const headingRegex = /^##\s+(.+)$/gm;
  let match: RegExpExecArray | null;
  let lastHeading: string | null = null;
  let lastIndex = 0;

  while ((match = headingRegex.exec(markdown)) !== null) {
    if (lastHeading !== null) {
      const content = markdown.slice(lastIndex, match.index).trim();
      sections.push({ heading: lastHeading, content });
    }
    lastHeading = match[1].trim();
    lastIndex = headingRegex.lastIndex;
  }

  if (lastHeading !== null) {
    const content = markdown.slice(lastIndex).trim();
    sections.push({ heading: lastHeading, content });
  }

  return sections;
};

const sections = parseTopSections(markdownContent);

const getSection = (heading: string) =>
  sections.find((section) => section.heading === heading)?.content ?? "";

const getSubsection = (content: string, heading: string) => {
  const regex = new RegExp(
    `###\\s+${escapeRegExp(heading)}\\s*\\n([\\s\\S]*?)(?=\\n###\\s|$)`,
  );
  const match = content.match(regex);
  return match?.[1].trim() ?? "";
};

const intro = markdownContent.split(/\n##\s/)[0]?.trim() ?? "";
const introSentences = intro ? intro.split(/(?<=\.)\s+/) : [];
const heroSubtitle = introSentences[0] || weekend.shortDescription;
const introParagraph =
  introSentences.length > 1 ? introSentences.slice(1).join(" ").trim() : intro;

const voorWie = getSection("Voor wie");
const focus = getSection("Wat je leert / focus");
const naDitWeekend = getSection("Na dit weekend");
const begeleiding = getSection("Begeleiding");
const programma = getSection("Programma");
const verblijf = getSection("Verblijf & maaltijden");
const praktisch = getSection("Praktisch");
const boekJePlek = getSection("Boek je plek");
const twijfel = getSection("Twijfel je nog?");
const goedOmWeten = getSection("Goed om weten");

const programmaDays = Array.from(
  programma.matchAll(/###\s+(.+?)\n([\s\S]*?)(?=\n###\s|$)/g),
).map((match, index) => ({
  id: `programma-${index + 1}`,
  title: match[1].trim(),
  content: marked.parse(match[2].trim()) as string,
  defaultOpen: match[1].includes("Dag 2"),
}));

const praktischIntro = praktisch.split(/\n###\s/)[0]?.trim() ?? "";
const vroegboekkado = getSubsection(praktisch, "Vroegboekkado");
const inbegrepen = getSubsection(praktisch, "Wat is inbegrepen");
const nietInbegrepen = getSubsection(praktisch, "Wat is niet inbegrepen");

const verblijfParagraphs = verblijf ? verblijf.split(/\n\s*\n/) : [];
const verblijfText = verblijfParagraphs[0]?.trim() ?? "";
const maaltijdenText = verblijfParagraphs.slice(1).join("\n\n").trim();

const groupSizeMatch = markdownContent.match(
  /\*\*Aantal deelnemers:\*\*\s*([^\n]+)/,
);
const groupSize = groupSizeMatch?.[1].trim();

const earlyBirdDateMatch = markdownContent.match(
  /Schrijf je in vóór ([\w\s]+\d{4})/i,
);
const earlyBirdLine = earlyBirdDateMatch
  ? `Vroegboekcadeau – schrijf je in vóór ${earlyBirdDateMatch[1]}`
  : undefined;

const simonImage = await getImage({
  src: simonPortrait,
  width: 520,
  quality: 85,
});
const showSimon = weekend.slug === "exercise-is-medicine";

const tocItems = [
  { id: "voor-wie", label: "Voor wie", enabled: Boolean(voorWie) },
  {
    id: "wat-je-leert-focus",
    label: "Wat je leert / focus",
    enabled: Boolean(focus),
  },
  {
    id: "na-dit-weekend",
    label: "Na dit weekend",
    enabled: Boolean(naDitWeekend),
  },
  {
    id: "expertise-coordinatie",
    label: "Expertise & coördinatie",
    enabled: Boolean(begeleiding),
  },
  { id: "programma", label: "Programma", enabled: Boolean(programma) },
  { id: "verblijf", label: "Verblijf", enabled: Boolean(verblijfText) },
  { id: "maaltijden", label: "Maaltijden", enabled: Boolean(maaltijdenText) },
  { id: "praktisch", label: "Praktisch", enabled: Boolean(praktisch) },
  {
    id: "vroegboekcadeau",
    label: "Vroegboekcadeau",
    enabled: Boolean(vroegboekkado),
  },
  { id: "inbegrepen", label: "Inbegrepen", enabled: Boolean(inbegrepen) },
  {
    id: "niet-inbegrepen",
    label: "Niet inbegrepen",
    enabled: Boolean(nietInbegrepen),
  },
  {
    id: "cta-early-bird",
    label: "CTA + early bird reminder",
    enabled: Boolean(earlyBirdLine),
  },
  { id: "boek-je-plek", label: "Boek je plek", enabled: Boolean(boekJePlek) },
  {
    id: "twijfel-je-nog",
    label: "Twijfel je nog? Plan een gesprek",
    enabled: Boolean(twijfel),
  },
  {
    id: "goed-om-weten",
    label: "Goed om weten",
    enabled: Boolean(goedOmWeten),
  },
].filter((item) => item.enabled);
---

<BaseLayout
  title={`SOLA | ${weekend.name}`}
  description={weekend.shortDescription}
>
  <ConversionHero
    weekend={weekend}
    subtitle={heroSubtitle}
    primaryCtaHref="#boek-je-plek"
    secondaryCtaHref="/contact"
  />

  <section class="bg-base-25 border-b border-base-200">
    <div class="max-w-6xl mx-auto px-6 py-10 lg:py-12">
      <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_240px] items-start">
        <div class="space-y-6">
          <dl class="grid gap-4 text-base text-base-700 sm:grid-cols-2">
            <div>
              <dt class="text-xs uppercase tracking-[0.2em] text-base-500">
                Wanneer
              </dt>
              <dd class="mt-2 font-semibold text-base-900">{weekend.dates}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-[0.2em] text-base-500">
                Waar
              </dt>
              <dd class="mt-2 font-semibold text-base-900">
                {weekend.location}
              </dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-[0.2em] text-base-500">
                Prijs
              </dt>
              <dd class="mt-2 font-semibold text-base-900">{weekend.price}</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-[0.2em] text-base-500">
                Groep
              </dt>
              <dd class="mt-2 font-semibold text-base-900">
                {groupSize ?? "Kleine groep"}
              </dd>
            </div>
          </dl>
          {earlyBirdLine && (
            <p class="text-sm font-semibold text-base-900">{earlyBirdLine}</p>
          )}
        </div>
        {introParagraph && (
          <div class="text-base text-base-700" data-reveal>
            <p class="leading-relaxed">{introParagraph}</p>
          </div>
        )}
      </div>
    </div>
  </section>

  <section class="bg-base-25">
    <div class="max-w-6xl mx-auto px-6 py-12 lg:py-16 pb-24">
      <div class="grid gap-10 lg:grid-cols-[200px_minmax(0,1fr)_220px]">
        <ScrollSpyTOC items={tocItems} />

        <div class="space-y-12">
          {voorWie && (
            <section
              id="voor-wie"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">Voor wie</h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(voorWie) as string}
              />
            </section>
          )}

          {focus && (
            <section
              id="wat-je-leert-focus"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">
                Wat je leert / focus
              </h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(focus) as string}
              />
            </section>
          )}

          {naDitWeekend && (
            <section
              id="na-dit-weekend"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">
                Na dit weekend
              </h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(naDitWeekend) as string}
              />
            </section>
          )}

          {begeleiding && (
            <section
              id="expertise-coordinatie"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">
                Expertise & coördinatie
              </h2>
              <div class="mt-6 grid gap-6 md:grid-cols-[180px_minmax(0,1fr)] items-start">
                {showSimon ? (
                  <div class="space-y-3">
                    <img
                      src={simonImage.src}
                      alt="Simon (Endurance Lab)"
                      class="h-52 w-full rounded-2xl object-cover"
                      loading="lazy"
                    />
                    <div class="text-sm text-base-600">
                      <p class="font-semibold text-base-900">
                        Simon (Endurance Lab)
                      </p>
                      <a
                        href="https://www.instagram.com/simonendurancelab"
                        class="text-base-600 underline-offset-4 hover:underline"
                      >
                        Instagram
                      </a>
                    </div>
                  </div>
                ) : (
                  <div class="hidden md:block" />
                )}
                <div
                  class="prose prose-base-900 max-w-none text-base-700"
                  set:html={marked.parse(begeleiding) as string}
                />
              </div>
            </section>
          )}

          {programma && (
            <section
              id="programma"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">Programma</h2>
              <Accordion items={programmaDays} />
            </section>
          )}

          {verblijfText && (
            <section
              id="verblijf"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">Verblijf</h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(verblijfText) as string}
              />
            </section>
          )}

          {maaltijdenText && (
            <section
              id="maaltijden"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">Maaltijden</h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(maaltijdenText) as string}
              />
            </section>
          )}

          {praktisch && (
            <section
              id="praktisch"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">Praktisch</h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(praktischIntro) as string}
              />
            </section>
          )}

          {vroegboekkado && (
            <section
              id="vroegboekcadeau"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">
                Vroegboekcadeau
              </h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(vroegboekkado) as string}
              />
            </section>
          )}

          {inbegrepen && (
            <section
              id="inbegrepen"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <Accordion
                items={[
                  {
                    id: "inbegrepen",
                    title: "Inbegrepen",
                    content: marked.parse(inbegrepen) as string,
                    defaultOpen: true,
                  },
                ]}
              />
            </section>
          )}

          {nietInbegrepen && (
            <section
              id="niet-inbegrepen"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <Accordion
                items={[
                  {
                    id: "niet-inbegrepen",
                    title: "Niet inbegrepen",
                    content: marked.parse(nietInbegrepen) as string,
                  },
                ]}
              />
            </section>
          )}

          {earlyBirdLine && (
            <section
              id="cta-early-bird"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">
                CTA + early bird reminder
              </h2>
              <p class="mt-4 text-base font-semibold text-base-900">
                {earlyBirdLine}
              </p>
              <div class="mt-6 flex flex-wrap gap-3">
                <a
                  href="/contact"
                  class="cta-primary inline-flex items-center justify-center rounded-full border border-base-300 px-5 py-2 text-sm font-semibold text-base-900"
                >
                  Boek dit weekend
                </a>
                <a
                  href="/contact"
                  class="cta-secondary inline-flex items-center justify-center rounded-full border border-base-300 px-5 py-2 text-sm font-semibold text-base-900"
                >
                  Contacteer ons voor meer info
                </a>
              </div>
            </section>
          )}

          {boekJePlek && (
            <section
              id="boek-je-plek"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">Boek je plek</h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(boekJePlek) as string}
              />
              <div class="mt-6 flex flex-wrap gap-3">
                <a
                  href="/contact"
                  class="cta-primary inline-flex items-center justify-center rounded-full border border-base-300 px-5 py-2 text-sm font-semibold text-base-900"
                >
                  Boek dit weekend
                </a>
                <a
                  href="/contact"
                  class="cta-secondary inline-flex items-center justify-center rounded-full border border-base-300 px-5 py-2 text-sm font-semibold text-base-900"
                >
                  Contacteer ons voor meer info
                </a>
              </div>
            </section>
          )}

          {twijfel && (
            <section
              id="twijfel-je-nog"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">
                Twijfel je nog? Plan een gesprek
              </h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(twijfel) as string}
              />
              <a
                href="/contact"
                class="cta-secondary mt-6 inline-flex items-center justify-center rounded-full border border-base-300 px-5 py-2 text-sm font-semibold text-base-900"
              >
                Contacteer ons voor meer info
              </a>
            </section>
          )}

          {goedOmWeten && (
            <section
              id="goed-om-weten"
              data-scrollspy-section
              class="section-anchor section-block" data-reveal
            >
              <h2 class="text-2xl font-semibold text-base-900">Goed om weten</h2>
              <div
                class="prose prose-base-900 mt-4 max-w-none text-base-700"
                set:html={marked.parse(goedOmWeten) as string}
              />
            </section>
          )}
        </div>

        <StickyBookingCard
          weekend={weekend}
          groupSize={groupSize}
          ctaHref="#boek-je-plek"
        />
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .section-anchor {
    scroll-margin-top: 120px;
  }

  .section-block {
    padding-bottom: 2.5rem;
    border-bottom: 1px solid var(--color-base-200);
  }

  .section-block:last-of-type {
    border-bottom: none;
    padding-bottom: 0;
  }

  .scrollspy-link.is-active {
    color: var(--color-base-900);
    text-decoration: underline;
    text-underline-offset: 4px;
  }

  .cta-primary,
  .cta-secondary {
    transition: transform 150ms ease, color 150ms ease,
      background-color 150ms ease, border-color 150ms ease;
  }

  .cta-primary:hover,
  .cta-secondary:hover {
    transform: translateY(-1px);
  }

  .accordion-panel {
    max-height: 0;
    opacity: 0;
    transition: max-height 250ms ease, opacity 250ms ease;
  }

  .accordion-item.is-open .accordion-panel {
    opacity: 1;
  }

  .accordion-icon {
    transition: transform 200ms ease;
  }

  .accordion-item.is-open .accordion-icon {
    transform: rotate(45deg);
  }

  [data-reveal] {
    opacity: 0;
    transform: translateY(16px);
    transition: opacity 450ms ease, transform 450ms ease;
  }

  [data-reveal].is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .cta-primary,
    .cta-secondary,
    .accordion-panel,
    .accordion-icon,
    [data-reveal] {
      transition: none;
    }

    [data-reveal] {
      opacity: 1;
      transform: none;
    }
  }
</style>

<script type="module">
  const prefersReducedMotion = window.matchMedia(
    "(prefers-reduced-motion: reduce)",
  ).matches;

  const revealTargets = document.querySelectorAll("[data-reveal]");
  if (!prefersReducedMotion && revealTargets.length) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("is-visible");
          }
        });
      },
      { threshold: 0.15 },
    );

    revealTargets.forEach((target) => observer.observe(target));
  } else {
    revealTargets.forEach((target) => target.classList.add("is-visible"));
  }

  const accordionGroups = document.querySelectorAll("[data-accordion]");
  const setAccordionState = (item, shouldOpen) => {
    const trigger = item.querySelector(".accordion-trigger");
    const panel = item.querySelector(".accordion-panel");
    if (!trigger || !panel) return;
    item.classList.toggle("is-open", shouldOpen);
    trigger.setAttribute("aria-expanded", String(shouldOpen));
    panel.style.maxHeight = shouldOpen ? `${panel.scrollHeight}px` : "0px";
  };

  accordionGroups.forEach((group) => {
    const items = group.querySelectorAll("[data-accordion-item]");
    items.forEach((item) => {
      const trigger = item.querySelector(".accordion-trigger");
      const shouldOpen = item.dataset.defaultOpen === "true";
      setAccordionState(item, shouldOpen);

      trigger?.addEventListener("click", () => {
        const isOpen = item.classList.contains("is-open");
        setAccordionState(item, !isOpen);
      });
    });
  });

  window.addEventListener("resize", () => {
    document.querySelectorAll(".accordion-item.is-open").forEach((item) => {
      const panel = item.querySelector(".accordion-panel");
      if (panel) {
        panel.style.maxHeight = `${panel.scrollHeight}px`;
      }
    });
  });

  const scrollLinks = document.querySelectorAll("[data-scrollspy-link]");
  scrollLinks.forEach((link) => {
    link.addEventListener("click", (event) => {
      const href = link.getAttribute("href");
      if (!href || !href.startsWith("#")) return;
      const target = document.querySelector(href);
      if (!target) return;
      event.preventDefault();
      target.scrollIntoView({
        behavior: prefersReducedMotion ? "auto" : "smooth",
        block: "start",
      });
    });
  });

  const sections = Array.from(
    document.querySelectorAll("[data-scrollspy-section]"),
  );
  const activateScrollSpy = () => {
    const offset = 140;
    let activeId = sections[0]?.id;
    sections.forEach((section) => {
      const top = section.getBoundingClientRect().top;
      if (top <= offset) {
        activeId = section.id;
      }
    });

    scrollLinks.forEach((link) => {
      const id = link.getAttribute("data-scrollspy-id");
      link.classList.toggle("is-active", id === activeId);
    });
  };

  window.addEventListener("scroll", activateScrollSpy, { passive: true });
  window.addEventListener("resize", activateScrollSpy);
  activateScrollSpy();
</script>
